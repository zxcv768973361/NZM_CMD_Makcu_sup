# 🗺️ 地图配置文件指南 (`*地图.json`)

`*地图.json`（例如 `空间站普通地图.json`）是 **NZM_CMD** 塔防系统理解战场环境的核心数据文件。它描述了地图的物理参数、地形网格以及进入战场前的预备动作。

程序通过此文件将抽象的“网格坐标”转换为屏幕上的“像素坐标”，并利用地形信息判断哪些位置可以放置陷阱。

这个的编辑请使用另一个项目[逆战未来地图编辑器](https://github.com/Minkelxy/MINKE-s-Indexed-NiZhan-Keypoint-Environment)

---

## 📚 核心结构概览

一个标准的地图文件包含三个主要部分：

1. **基础信息 (`map_name`)**：地图的标识符。
2. **元数据 (`meta`)**：决定坐标转换的核心参数（缩放、偏移、预备动作）。
3. **图层数据 (`layers`)**：定义了地图上的可建筑区域（地面、墙面、天花板）。

---

## 📝 字段详解与编辑教学

### 1. 基础信息

```json
{
  "map_name": "Ni-Zhan_Map"  // 地图名称，通常用于日志输出
}

```

### 2. 元数据 (`meta`) ✨ 核心参数

这是最重要的部分，错误的参数会导致所有陷阱放歪。建议配合 `tool` 工具进行测量。

```json
"meta": {
  "grid_pixel_size": 21.3,  // [关键] 每个网格在 1080p 屏幕上占据的像素宽度/高度
                            // 即使有 0.1 的误差，累积到地图边缘也会导致巨大偏移。
                            
  "offset_x": 144.0,        // [关键] 地图左上角第一个网格中心点的屏幕 X 坐标
  "offset_y": 179.0,        // [关键] 地图左上角第一个网格中心点的屏幕 Y 坐标
  
  "bottom": 1992.0,         // 地图在 Y 轴方向的总像素高度（用于计算卷动距离）
  
  "prep_actions": [...]     // 预备动作序列（见下文）
}

```

#### 🛠️ 如何校准 `meta` 参数？

1. 运行 `tool` 工具。
2. 在游戏中找到地图最左上角的一个清晰网格。
3. 鼠标悬停在网格中心，记下坐标 `(x1, y1)`。这就是 `offset_x` 和 `offset_y` 的大致值。
4. 找到水平方向第 10 个网格的中心，记下 `x2`。
5. 计算 `grid_pixel_size = (x2 - x1) / 10`。取平均值能大幅提高精度。

### 3. 预备动作 (`prep_actions`) 🏃

这是进入地图后、开始放置陷阱前执行的一系列脚本动作。常用于“卡位置”或“物理归零”。

**支持的动作类型：**

* **`Log`**: 输出日志，用于提示当前阶段。
* **`KeyDown`**: 按下某个键（不松开）。
* **`KeyUpAll`**: 松开所有按键。
* **`Wait`**: 等待指定毫秒数。

**示例：开局助跑跳（用于卡进某些特殊点位）**

```json
"prep_actions": [
  { "type": "Log", "msg": "开始执行开局跑图逻辑..." },
  
  // 长按 W 助跑 1秒
  { "type": "KeyDown", "key": "w" },
  { "type": "Wait", "ms": 1000 },
  
  // 起跳！(W 依然按着)
  { "type": "KeyDown", "key": " " }, // 空格键
  { "type": "Wait", "ms": 100 },
  
  // 松开所有键，完成动作
  { "type": "KeyUpAll" },
  
  // 落地缓冲
  { "type": "Wait", "ms": 500 }
]

```

### 4. 图层数据 (`layers`)

定义了哪些格子是地面（Floor），哪些是墙（Wall），哪些是天花板（Ceiling）。目前主要关注 `Layer_0`。

```json
"layers": [
  {
    "major_z": 0,           // 层级高度（目前主要用 0）
    "name": "Layer_0",
    
    // 地面网格数据：二维数组
    // -1: 不可建造区域
    //  0: 平地 (Floor)
    //  1: 高台1
    "floor_grid": [
      [-1, -1,  0,  0, -1], // 第 0 行
      [-1,  0,  0,  0, -1], // 第 1 行
      ...
    ],
    
    // 墙面网格（同理）
    "wall_grid": [...],
    
    // 天花板网格（同理）
    "ceiling_grid": [...]
  }
]

```

#### 🛠️ 编辑技巧

* **手动编辑**：对于简单的修正（如把某个不可造的点改为可造），可以直接修改 JSON 里的 `-1` 为 `0`。
* **自动生成**：通常不建议手写整个 grid。建议使用配套的 `MapEditor` 工具（开发中）来通过点击生成网格数据，然后导出为此 JSON 格式。

---

## ⚠️ 常见问题

1. **陷阱总是放歪一点点？**
* 检查 `offset_x` 和 `offset_y` 是否对齐了第一个格子的中心。
* 微调 `grid_pixel_size`。如果越靠右的陷阱偏得越厉害，说明这个值不准。


2. **到了位置不放陷阱？**
* 检查 `floor_grid` 在对应坐标的值是否为 `-1`。程序会拒绝在 `-1` 的位置尝试放置。


3. **预备动作没反应？**
* 确保 `prep_actions` 写在 `meta` 内部。
* 检查 `key` 是否为小写字母或空格。