# 🗺️ UI Map 配置指南 (`ui_map.toml`)

`ui_map.toml` 是 **NZM_CMD** 智能导航系统的核心配置文件。它定义了程序如何“看懂”游戏界面，以及如何在不同的界面之间进行跳转。

`NavEngine`（导航引擎）会读取此文件，构建一个有向图，从而自动规划从“当前界面”到“目标界面”的点击路径。

---

## 📚 核心概念

配置文件由一系列的 **场景 (Scenes)** 组成。每个场景代表游戏中的一个独立界面（如：大厅、任务面板、地图选择页）。

一个标准的场景包含三个要素：

1. **身份 (Identity)**：我是谁？（ID 和 名称）
2. **锚点 (Anchors)**：怎么确定我在这个界面？（OCR 文字识别或颜色匹配）
3. **跳转 (Transitions)**：我能去哪？（点击哪里可以跳转到下一个界面）
4. **路由 (Handler)**：到达后谁来接管？（可选，移交控制权给业务逻辑）

---

## 📝 字段详解与编辑教学

### 1. 定义一个场景 (`[[scenes]]`)

每个界面以 `[[scenes]]` 开头。

```toml
[[scenes]]
id = "任务系统"          # [必填] 唯一标识符，代码中导航的目标(target)就是指这个ID
name = "任务系统"        # [选填] 备注名称，用于日志显示
logic = "or"            # [选填] 锚点匹配逻辑。
                        # "and" (默认): 必须满足所有锚点才算识别成功
                        # "or": 只要满足任意一个锚点就算识别成功
handler = "daily"       # [可选] 路由标记。到达此界面后，将控制权移交给特定模块

```

### 2. 定义识别锚点 (`[scenes.anchors]`)

程序通过截图并识别特定区域的内容来判断当前是否处于该场景。

* **文字锚点 (`text`)**: 使用 OCR 识别区域内的文字。
* **颜色锚点 (`color`)**: (预留功能) 识别特定点的像素颜色。

```toml
[scenes.anchors]
text = [
  # rect = [左上X, 左上Y, 右下X, 右下Y]
  # val  = "期望识别到的文字（支持模糊匹配）"
  { rect = [297, 60, 378, 96], val = "赛季任务" },
  
  # 可以定义多个锚点来增加识别准确率
  { rect = [125, 50, 748, 115], val = "赛季等级" },
]

```

> **💡 编辑技巧**：
> * 使用项目提供的 `tool` 工具获取坐标。
> * `rect` 区域尽量画小一点，只包含关键文字，这样 OCR 速度快且准。
> * `val` 不需要完全匹配，只要识别结果包含这个字符串即可。
> 
> 

### 3. 定义跳转动作 (`[[scenes.transitions]]`)

告诉程序，在这个界面点击哪个坐标，可以去往哪个新界面。一个场景可以有多个跳转目标。

```toml
# 跳转动作 A
[[scenes.transitions]]
target = "赛季任务"      # 目标场景的 ID (必须在某处定义过这个ID)
coords = [337, 77]      # 点击坐标 [X, Y]
post_delay = 500        # 点击后的等待时间 (毫秒)，等待UI动画播放完毕

# 跳转动作 B
[[scenes.transitions]]
target = "返回大厅"
coords = [1800, 50]
post_delay = 1000

```

### 4. 业务接管路由 (`handler`) ✨

这是连接“自动导航”与“具体业务逻辑（如塔防、领奖）”的桥梁。

当导航引擎到达一个配置了 `handler` 的界面时，它会停止导航，并返回 `Handover` 信号给主程序。

* **`handler = "daily"`**: 告诉主程序启动 **日活任务模块 (`DailyRoutineApp`)**。
* *适用场景*：每日目标、任务面板。


* **`handler = "td"`**: 告诉主程序启动 **塔防战斗模块 (`TowerDefenseApp`)**。
* *适用场景*：进入具体的地图房间（如空间站炼狱、普通等）。



**示例：**

```toml
[[scenes]]
id = "每日目标"
name = "每日目标"
handler = "daily"  # 到达这里后，开始自动领奖/刷新任务

[[scenes]]
id = "空间站炼狱"
name = "空间站炼狱"
handler = "td"     # 到达这里后，开始执行塔防挂机逻辑

```

---

## ⚡ 常见配置模式

### 模式 A: 纯导航节点 (Hub)

例如“游戏大厅”，它有锚点用于确认位置，有多个 Transition 指向不同子功能。

```toml
[[scenes]]
id = "游戏大厅主界面"
logic = "and"
[scenes.anchors]
text = [ { rect = [1580, 882, 1762, 958], val = "选择玩法" } ]

[[scenes.transitions]]
target = "任务系统"
coords = [1663, 200]

[[scenes.transitions]]
target = "选择玩法"
coords = [1672, 924]

```

### 模式 B: 虚拟路由节点 (Virtual Router)

有些界面不需要程序去“识别”（因为我们刚点击进来，确信就在这里），或者该界面是最终目的地。这种界面通常配置 `handler` 且**不配置 anchors**。

**无锚点 (No Anchors) 的特性：**

* 如果一个场景没有配置 anchors，导航引擎会认为这是一个“虚拟节点”。
* 一旦跳转路径规划到这个节点，导航引擎会立即视为“已到达”并移交控制权。

```toml
[[scenes]]
id = "空间站普通"
name = "空间站普通"
handler = "td"  # 这是一个终点，到达后直接把 scene_id 传给塔防程序加载对应地图json
# 注意：这里没有 [scenes.anchors]，依靠上一个界面的点击直接进入

```

---

## 🛠️ 调试建议

1. **坐标获取**：运行 `cargo run --release --bin tool` 启动调试工具，鼠标悬停即可获得准确坐标。
2. **OCR 测试**：在工具中框选区域进行 OCR 测试，确保 `val` 填写的文字能被稳定识别。
3. **路径检查**：
* 如果提示 `❌ 无法定位起点`：说明当前界面的 `anchors` 配置有误，或者 OCR 识别失败。
* 如果提示 `❌ 无路可走`：说明从“起点”到“终点”的跳转链条断了，检查 `transitions` 的 `target` 是否拼写正确。