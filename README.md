# NZM_CMD - 逆战：未来指挥官

**NZM_CMD** 是《逆战：未来》塔防模式设计的自动化辅助框架。

与传统的“按键精灵”或基于 Win32 API (`SendInput`) 的脚本不同，本项目采用了 **硬件级输入模拟 (Hardware-Level Input Simulation)** 与 **计算机视觉 (Computer Vision)** 相结合的方案。它不读取任何游戏内存，完全模拟人类玩家的视觉判断与物理操作，旨在提供最安全、最稳定的挂机体验。

## 🎯 长期目标

1. **全场景自动化覆盖 (Full Scenario Coverage)**
* 实现对塔防模式下**所有地图**及**所有难度等级**（普通/困难/英雄/炼狱）的策略支持与自动化挂机。


2. **全链路日活托管 (End-to-End Daily Loop)**
* 打通“登录 -> 战斗 -> 结算 -> 领奖”的全流程闭环，实现零人工干预的日活清理。


3. **弹性事件调度系统 (Flexible Event Scheduler)**
* 构建可配置的事件驱动引擎，支持通过 JSON/TOML 配置定义任意时刻的对局计划。如：特定时间段刷特定副本。


4. **UI 资产持续集成 (UI Asset Maintenance)**
* 建立标准化的 UI 映射数据库（UI Map），通过配套工具链（`tool`）快速适配游戏版本更新带来的界面变动，降低维护成本。

---

## 🛡️ 核心技术：硬件级拟人输入 (The Hardware Layer)

本项目最引以为傲的是其底层的输入输出系统，旨在彻底绕过常规反作弊系统（如 ACE/TP）的行为检测。

### 1. 物理层 HID 模拟

代码直接通过底层的 **HID (Human Interface Device)** 协议与输入设备通信，而非调用操作系统的软件模拟接口。

* **扫描码指令 (Raw Scancodes)**：
* 在处理战术动作（如 `W+Space` 大跳）时，程序直接发送硬件扫描码（如 `0x1A` 对应 W，`0x2C` 对应 Space）。
* 支持**组合键并发**（Key Down 叠加）与**精确时序控制**（微秒级 Sleep），完美复刻物理键盘的电信号行为。


* **硬件隔离**：输入指令在系统层面被识别为来自真实的物理 USB 设备，而非软件虚拟设备。

### 2. 生物力学鼠标轨迹 (`HumanDriver`)

为了通过行为审计，我们引入了基于生物力学的鼠标移动算法，拒绝机械直连：

* **贝塞尔曲线路径 (Bézier Curves)**：鼠标从 A 点移动到 B 点，不会走直线，而是生成一条平滑的、符合手腕转动习惯的三阶贝塞尔曲线。
* **速度非线性化**：模拟人类肌肉的“启动-加速-减速-微调”过程，移动速度呈正态分布变化。
* **过冲与抖动 (Overshoot & Jitter)**：在到达目标点前，算法会随机生成微小的过冲量和修正回拉，并叠加高频微颤，模拟手部生理抖动。

### 3. 随机化时序

* **高斯分布延迟**：按键的按下时长（Press Duration）和两次操作间的间隔（Interval）均服从高斯分布，没有两次操作的时间是完全相同的。

---

## 🧠 智能塔防策略引擎

不仅是输入模拟，NZM_CMD 还拥有一个能够理解战场状态的“大脑”。

### 1. 消除死航误差 (Dead Reckoning Correction)

针对长时间挂机导致的角色位置漂移问题，引入了 **“分区锚定策略” (Zone Anchoring Strategy)**：

* **动态分区**：将地图逻辑划分为“上半区”和“下半区”。
* **物理归零**：在执行每组任务前，强制长按 W 或 S 将角色顶在地图边缘，建立绝对物理坐标系。
* **相对位移计算**：基于归零后的基准线计算移动距离，将长时间运行的累积误差降至 **0**。

### 2. 鲁棒的交互逻辑

* **三连击选陷阱 (Triple-Tap Selection)**：采用 `目标键 -> 干扰键 -> 目标键` (如 `4-5-4`) 的强制刷新逻辑，确保在网络波动或 UI 延迟下，陷阱选中率达到 100%。
* **智能任务调度**：自动对同波次的拆除、建造、升级任务按 Y 轴坐标排序，实现“顺路执行”，大幅减少屏幕往返滚动。

### 3. 全局波次监控

* **混合 OCR 策略**：
* **大厅/备战**：在大范围区域扫描“波次”关键字。
* **战斗中**：自动按住 `TAB` 键呼出战绩板，利用 Windows OCR 精准识别 `2/5波次` 格式，识别完成后自动释放按键，流程如丝般顺滑。

---

## 🏗️ 项目架构

```text
NZM_CMD/
├── src/
│   ├── main.rs           # 程序主入口与线程调度
│   ├── tower_defense.rs  # [核心] 塔防业务逻辑、策略调度、坐标计算
│   ├── human.rs          # [核心] 拟人化算法、贝塞尔曲线、随机分布生成
│   ├── nav.rs            # [核心] 导航系统、Windows OCR 封装、屏幕截图
│   ├── utils.rs          # 通用工具
│   └── models.rs         # 数据结构定义
├── tool/                 # 配套工具：基于 egui 的 UI 建模与 OCR 调试器
├── strategy_01.json      # 塔防建造策略配置
├── traps_config.json     # 陷阱 UI 坐标映射
└── Cargo.toml

```

---

## 🚀 快速开始

### 环境要求

* **OS**: Windows 10 / 11 (需启用 Windows OCR 服务)
* **分辨率**: 1920x1080 (100% 缩放)
* **硬件**: 建议配合支持 HID 脚本的硬件（如 KMBox、Leonardo 等）使用，或使用兼容的软件驱动。

### 编译与运行

1. **克隆项目**
```bash
git clone https://github.com/minkelxy/NZM_CMD.git
cd NZM_CMD

```


2. **编译 Release 版本** (推荐，以获得最佳 OCR 性能)
```bash
cargo build --release

```


3. **运行**
请先进入游戏大厅或房间，然后以管理员权限运行：
```bash
cargo run --release

```



### 使用配置工具

如果你需要适配新的地图或调整识别区域：

```bash
cd tool
cargo run --release

```

利用工具中的 **"3秒延时截图"** 和 **"区域 OCR 测试"** 功能，快速获取 JSON 配置文件所需的坐标参数。

---

## ⚠️ 免责声明

* 本项目仅作为 **Rust 系统编程**、**计算机视觉**及**自动化控制**技术的学习研究案例。
* **严禁**将本项目用于任何破坏游戏平衡、盈利或非法用途。
* 使用任何辅助软件均存在账号封禁风险，开发者不对使用本项目产生的任何后果负责。

---

## 📜 License

MIT License