# 🏗️ 塔防策略配置文件指南 (`*策略.json`)

`*策略.json`（例如 `空间站普通策略.json`）是 **NZM_CMD** 的“作战指挥书”。它告诉程序在第几波、什么时间点、在什么位置放置或升级什么陷阱。


这个的编辑请使用另一个项目[逆战未来地图编辑器](https://github.com/Minkelxy/MINKE-s-Indexed-NiZhan-Keypoint-Environment)
该文件通常由配套的 **可视化编辑器 (Tool)** 生成，但了解其结构有助于进行微调或 debug。
---

## 📚 核心结构概览

一个标准的策略文件包含四个主要部分：

1. **地图标识 (`map_name`)**：用于校验策略是否匹配当前地图。
2. **建造指令 (`buildings`)**：定义陷阱的放置位置和时间。
3. **升级指令 (`upgrades`)**：定义何时升级某种陷阱。
4. **拆除指令 (`demolishes`)**：定义何时回收陷阱以腾出人口或资金。

---

## 📝 字段详解

### 1. 建造指令 (`buildings`)

这是最核心的部分，是一个对象数组。每个对象代表一个具体的陷阱实例。

```json
"buildings": [
  {
    "uid": 1008,                // [唯一ID]用于系统内部追踪。拆除时也是通过此ID查找。
    "name": "破坏者",           // [名称] 必须与 traps_config.json 中的名称一致
    "b_type": "Floor",          // [类型] Floor(地面), Wall(墙面), Ceiling(天花板)
    
    // [坐标与尺寸]
    "grid_x": 32,               // 网格列号 (Column)
    "grid_y": 32,               // 网格行号 (Row)
    "width": 4,                 // 陷阱占据的宽度 (格)
    "height": 4,                // 陷阱占据的高度 (格)
    
    // [时序控制]
    "wave_num": 1,              // 在第几波执行此操作
    "is_late": false            // false=准备阶段(前期), true=战斗阶段(后期)
  },
  ...
]

```

### 2. 升级指令 (`upgrades`)

定义何时对某种类型的陷阱进行升级操作（通常对应游戏中的长按对应数字键）。

```json
"upgrades": [
  {
    "building_name": "破坏者",  // 要升级的陷阱名称
    "wave_num": 2,              // 在第 2 波
    "is_late": true             // 在战斗阶段执行
  }
]

```

> **注意**：程序会自动识别当前携带的陷阱键位，并执行长按操作。

### 3. 拆除指令 (`demolishes`)

定义何时卖掉某个特定的陷阱。

```json
"demolishes": [
  {
    "uid": 1008,                // 必须对应 buildings 中定义的 uid
    "name": "破坏者",           // 仅作备注用
    "grid_x": 32,               // 坐标辅助定位
    "grid_y": 32,
    "wave_num": 3,              // 在第 3 波
    "is_late": false            // 在准备阶段拆除
  }
]

```

---

## ⏳ 时序控制详解 (`wave_num` & `is_late`)

NZM_CMD 将每一波的战斗分为两个阶段，这通过 `is_late` 字段来区分：

| 阶段名称 | is_late | 触发时机 | 典型用途 |
| --- | --- | --- | --- |
| **前期 (Prep Phase)** | `false` | 检测到新波次数字，但尚未按 `G` 开怪前。 | 大规模建造、拆除旧防线、调整布局。这是最安全的操作时间。 |
| **后期 (Combat Phase)** | `true` | 按下 `G` 键开怪之后，或者战斗进行中。 | 补漏、升级陷阱（有些升级需要等怪出）、紧急维修。 |

**执行顺序示例：**

1. **第 1 波 / 前期** (`wave:1, late:false`) -> 执行建造
2. **程序自动按 G 开怪**
3. **第 1 波 / 后期** (`wave:1, late:true`) -> 执行补建或升级
4. ...等待第 2 波文字出现...
5. **第 2 波 / 前期** (`wave:2, late:false`) -> 执行新一轮建造

---

## 🛠️ 编辑建议

### 1. 不要手动计算坐标

`grid_x` 和 `grid_y` 必须与地图的网格系统严格对齐。手写几乎肯定会出错。

* **推荐**：使用配套的 `tool` (MapEditor) 进行可视化编辑。
* **推荐**：在编辑器中点击放置，然后导出为 JSON。

### 2. UID 的唯一性

如果您手动复制粘贴了 `buildings` 里的条目，**务必修改 `uid**`。如果两个陷阱拥有相同的 `uid`，会导致拆除逻辑混乱（例如想拆A，结果程序把B当成了A）。

### 3. 陷阱名称匹配

`name` 字段必须能在 `traps_config.json` 中找到对应的配置，否则程序在执行时会报错 `[Config Error] 未找到陷阱配置`，且无法自动切换到该陷阱的键位。

### 4. 批量操作技巧

如果您想让一排陷阱都在第 3 波升级：

* **方法 A**：在 `upgrades` 里加一条记录，程序会尝试升级该类型。
* **方法 B**：如果需要精细控制（只升级特定的几个），目前 JSON 结构倾向于全局类型升级。如果需要特定升级，请确保策略逻辑支持（当前代码逻辑是按类型长按按键）。