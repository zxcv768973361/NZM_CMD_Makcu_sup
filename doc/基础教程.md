# NZM_CMD 使用手册 & 配置指南

欢迎使用 NZM_CMD。本手册将指导您从环境配置到编写自定义挂机策略的全过程。

---

## 📋 目录

1.  [环境准备与安装](#1-环境准备与安装)
2.  [运行程序](#2-运行程序)
3.  [核心配置详解](#3-核心配置详解)
    * [UI 导航图 (ui_map.toml)](#31-ui-导航图-ui_maptoml)
    * [地图配置 (*地图.json)](#32-地图配置-地图json)
    * [战斗策略 (*策略.json)](#33-战斗策略-策略json)
4.  [调试工具使用](#4-调试工具使用)

---

## 1. 环境准备与安装

### 系统要求
* **操作系统**: Windows 10 / 11 (必须启用 Windows OCR 服务，通常默认开启)。
* **显示分辨率**: **1920x1080**。
* **缩放比例**: 必须设置为 **100%** (在“显示设置”中调整)。

### 游戏要求
* **游戏刷新率**: 全60
* **显示分辨率**: 1920x1080
* **显示方式**: 无边框全屏


### 获取程序
* **方式 A (直接下载)**: 下载发布的 `Release` 压缩包，解压即可。
* **方式 B (源码编译)**:
    1.  安装 [Rust](https://www.rust-lang.org/tools/install)。
    2.  克隆仓库并编译：
        ```bash
        git clone [https://github.com/minkelxy/NZM_CMD.git](https://github.com/minkelxy/NZM_CMD.git)
        cd NZM_CMD
        cargo build --release
        ```
    3.  编译后的程序位于 `target/release/nzm_cmd.exe`。

---

## 2. 运行程序

由于程序需要模拟键鼠操作，**必须以管理员身份运行**。

### 推荐方式：使用批处理脚本 (.bat)
根目录下提供了 `启动日活.bat` 等脚本。
1.  右键点击脚本 -> 编辑。
2.  修改配置参数：
    ```batch
    :: 端口: SOFT (软件模拟) 或 COM3 (硬件串口)
    set PORT=SOFT
    :: 目标: 赛季任务 / 空间站普通 / 空间站炼狱
    set TARGET=赛季任务
    ```
3.  保存并双击运行（脚本会自动请求提权）。

### 进阶方式：命令行启动
打开管理员 PowerShell，进入程序目录：

```bash
# 语法: nzm_cmd.exe -p <端口> -t <目标>

# 示例：使用软件模式执行日活
./nzm_cmd.exe -p SOFT -t "赛季任务"

# 示例：使用硬件 COM9 端口挂机塔防
./nzm_cmd.exe -p COM9 -t "空间站炼狱"

```

---

## 3. 核心配置详解

NZM_CMD 的强大之处在于其高度可配置性。你可以通过修改配置文件来适配新活动或新地图。

### 3.1 UI 导航图 (`ui_map.toml`)

该文件定义了程序如何“看懂”界面并进行跳转。

**基本结构：**

```toml
[[scenes]]
id = "赛季任务"          # 场景唯一ID
name = "赛季任务"        # 备注名称
handler = "daily"       # [关键] 路由标记：daily(日活模块) / td(塔防模块)

# 识别锚点 (Anchors): 如何确认我在这个界面？
[scenes.anchors]
text = [
  # 在区域 [x1, y1, x2, y2] 内识别到文本 "挑战目标"
  { rect = [125, 114, 713, 157], val = "挑战目标" }
]

# 跳转动作 (Transitions): 怎么去下一个界面？
[[scenes.transitions]]
target = "每日目标"      # 下一个场景的ID
coords = [352, 132]     # 点击坐标
post_delay = 500        # 点击后等待毫秒数

```

> **💡 路由逻辑 (Handler)**:
> 当导航到达配置了 `handler` 的界面时，会自动移交控制权：
> * `handler = "daily"` -> 启动全自动日活脚本（领奖/刷新）。
> * `handler = "td"` -> 启动塔防战斗脚本（读取对应地图策略）。
> 
> 

### 3.2 地图配置 (`*地图.json`)

定义地图的物理参数，用于将网格坐标转换为屏幕像素。

**关键字段：**

```json
{
  "map_name": "Ni-Zhan_Map",
  "meta": {
    "grid_pixel_size": 21.3,  // [核心] 单个网格的像素大小
    "offset_x": 144.0,        // [核心] (0,0) 号网格中心的屏幕 X 坐标
    "offset_y": 179.0,        // [核心] (0,0) 号网格中心的屏幕 Y 坐标
    "bottom": 1992.0,         // 地图总高度（用于计算滚屏）
    
    // 进图后的预备动作（如卡位、助跑）
    "prep_actions": [
      { "type": "KeyDown", "key": "w" },
      { "type": "Wait", "ms": 1000 },
      { "type": "KeyUpAll" }
    ]
  },
  "layers": [...] // 地形网格数据，通常由工具自动生成
}

```

### 3.3 战斗策略 (`*策略.json`)

定义每一波的建造、升级和拆除指令。

**关键字段：**

```json
{
  // 1. 建造指令
  "buildings": [
    {
      "uid": 1001,              // 唯一ID
      "name": "破坏者",          // 陷阱名称（需与 traps_config.json 一致）
      "grid_x": 32, "grid_y": 32, // 网格坐标
      "wave_num": 1,            // 第几波执行
      "is_late": false          // false=前期(备战), true=后期(战斗中)
    }
  ],
  
  // 2. 升级指令
  "upgrades": [
    {
      "building_name": "破坏者", // 升级该名称的所有陷阱
      "wave_num": 2,
      "is_late": true
    }
  ],
  
  // 3. 拆除指令
  "demolishes": [
    {
      "uid": 1001,              // 对应 building 的 uid
      "wave_num": 3,
      "is_late": false
    }
  ]
}

```

---

## 4. 调试工具使用

项目附带了一个 `tool` 工具，用于辅助获取坐标和测试 OCR。

1. 进入 `tool` 目录。
2. 运行 `cargo run --release`。
3. **主要功能**：
* **实时坐标**：鼠标悬停在界面上，工具会显示当前屏幕坐标。
* **OCR 测试**：框选屏幕区域，查看 OCR 识别结果，用于校准 `ui_map.toml` 中的 `val` 字段。
* **截图分析**：按下截图热键，保存当前画面以便离线分析。
